<!DOCTYPE html>
<html>
<head>
	<title>Leon Scherer</title>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.0/howler.js"></script>
	<!-- <script src="db.js"></script> -->

	<style type="text/css">
		body {
			margin: 0;
			padding: 0;

			/* disable text select */
		    -webkit-touch-callout: none;
		    -webkit-user-select: none;
		    -khtml-user-select: none;
		    -moz-user-select: none;
		    -ms-user-select: none;
		    user-select: none;
		}

		/* hide blue outline when button highlighted */
		:focus {
			outline: none;
		}
	</style>
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<link rel="stylesheet" type="text/css" href="css/player.css">
	<link rel="stylesheet" type="text/css" href="css/nav.css">

	<script type="text/javascript">

		// global properties
		var currentMainIndex = null
		const fadeDuration = 250

		const tracks = {}
		var currentTrack = null

		const playlists = {}
		var currentPlaylist = null

		var seeking = false
		var seekPercentage = 0.0

		// set initial volume
		var currentVolume = 0.2
		Howler.volume(currentVolume)

		// --------------------------------------------

		Number.prototype.clamp = function(min, max) {
		  return Math.min(Math.max(this, min), max);
		}

		function getCurrentMainElement() {
			if (currentMainIndex != null) return '#main' + currentMainIndex
			else return null
		}

		function getCurrentTrack() {
			return tracks[currentTrack]
		}

		function pauseCurrentTrack() {
			if (getCurrentTrack() != null)
				getCurrentTrack().pause()
		}

		function toggleCurrentTrack() {
			if (getCurrentTrack() != null) {
				if (getCurrentTrack().playing()) getCurrentTrack().pause()
				else getCurrentTrack().play()
			}
		}

		function selectTrack(identifier) {
			// set
			currentTrack = identifier

			// TODO: set track metadata
			// TODO: load waveform image
		}

		async function loadTracks() {
			// load track data and metadata
			$.getJSON('https://fruup.github.io/tracks.json', function(data) {
				for (track in data) {
					tracks[track] = new Howl({
						src: ['https://fruup.github.io/wav/' + data[track].file],
						preload: false,
						//preload: true,
						html5: true
					})

					//tracks[track].load()
				}

				// set first track
				selectTrack(Object.keys(tracks)[0])

				// preload first track
				getCurrentTrack().load()
			})

			// load playlists
			$.getJSON('https://fruup.github.io/playlists.json', function(data) {
				// load tracks
				for (playlist in data) {
					playlists[playlist]
				}

				// set first track
				currentTrack = Object.keys(tracks)[0]
			})
		}

		function switchMain(which) {
			if (currentMainIndex != which) {

				if (currentMainIndex != null) {
					// animate menu button
					const prevMenuButton = '#menu' + currentMainIndex

					$(prevMenuButton).animate({
						opacity: '1.0'
					}, fadeDuration)
				}

				// animate new menu button
				const nextMenuButton = '#menu' + which
				$(nextMenuButton).animate({
					opacity: '.5'
				}, fadeDuration)

				function initNewMain() {
					// set new index
					currentMainIndex = which

					// fade in new main
					$(getCurrentMainElement()).fadeIn(fadeDuration)
					$(getCurrentMainElement()).show()
				}

				if (currentMainIndex != null) {
					// fade out prev main
					$(getCurrentMainElement()).fadeOut(fadeDuration, function() {
						// hide prev main
						$(getCurrentMainElement()).hide()

						// show new main
						initNewMain()
					})
				}

				// show new main
				else initNewMain()
			}
		}

		$(function()
		{
			// load tracks async
			loadTracks()

			// go to main page
			switchMain(1);

			// block scrolling through spacebar press, and pause/resume
			window.onkeydown = function(e) {
			  if (e.which == 32 && e.target == document.body) {
			  	// pause/resume track
				toggleCurrentTrack();

				// prevent scrolling
			    e.preventDefault();
			  }
			};

			// setup navigation buttons
			$('#menu1').click(function(event) { switchMain(1) })
			$('#menu2').click(function(event) { switchMain(2) })
			$('#menu3').click(function(event) { switchMain(3) })

			// setup player area
			$('#play').click(function() {
				toggleCurrentTrack();
			})

			// setup timeline interaction
			$('#timeline').mousedown(function(event) {

				// start seeking
				seeking = true

				// seek proc
				const func = function(event_) {
					if (event_.button == 0) {
						// calculate progress along timeline
						seekPercentage = ((event_.pageX - $('#timeline').offset().left) / $('#timeline').width()).clamp(0.0, 1.0)

						// set marker position
						$('#timelineMarker').css({ left: (100 * seekPercentage) + '%' })
					}
				}

				func(event)

				// listen for mouse move events
				$(document).on('mousemove', func)
			})

			$(document).mouseup(function(event) {
				// stop listening for mouse move events
				$(document).off('mousemove')

				if (seeking) {
					// seek track
					getCurrentTrack().seek(seekPercentage * getCurrentTrack().duration())

					// stop seeking
					seeking = false
				}
			})

			// start timeline update thread
			setInterval(function() {
				if (currentTrack != null && tracks[currentTrack].playing() && seeking == false) {
					const progress = tracks[currentTrack].seek() / tracks[currentTrack].duration()

					// update timeline slider
					$('#timelineMarker').css({ left: (100 * progress) + '%' })
				}
			}, 200)
		})

	</script>
</head>
<body>

	<div id='titleArea' style='width: 100%; height: 50px;'>
		<div style='font-family: "Cousine", monospace; font-size: 40px;'>
			leon scherer
		</div>
	</div>

	<div id='navBarAndMain'>
		<div id='navBar'>
			<div id='menuButtons'>
				<button id='menu1' class='menuButton'>Music</button>
				<button id='menu2' class='menuButton'>About</button>
				<button id='menu3' class='menuButton'>Contact</button>
			</div>
			
			<div id='socialButtons'>
				<div id='social1' class='socialButton'>
					<img class='socialImage' src='img/twitter.png'>
				</div>
				
				<img id='social2' class='socialButton' src='img/instagram.png'>
			</div>
		</div>

		<div id="main1" class='main'>
			Hi I make music check it out
		</div>

		<div id="main2" class='main'>
			Hi my name is Leon
		</div>

		<div id="main3" class='main'>
			Hit me up
		</div>
	</div>

	<div id='playerStickyFooter'>
		<div id='playerArea'>
			<img id='play' src='img/play.png'>

			<div id='trackMetaAndTimeline'>
				
				<div id='trackMeta'>
					<div id='trackMetaContent'>
						<div id='trackTitle' class='trackMeta' style='color: white;'> Track Title </div>
						<div id='trackMetaSpacer' class='trackMeta' style='color: lightgrey; margin: 0 5px;'> - </div>
						<div id='trackPlaylist' class='trackMeta' style='color: lightgrey;'> Playlist </div>
					</div>
				</div>

				<div id='timeline'>
					<img src='img/wavforms/chillig.png' style='width: 100%; height: 100%; object-fit: cover;'>

					<div id='timelineMarker'>
						<div id='timelineMarkerContent'></div>
					</div>
				</div>

			</div>

			<div id='volumeArea'>
				<div id='volumeSlider'>
					
				</div>
			</div>
		</div>
	</div>

</body>
</html>
